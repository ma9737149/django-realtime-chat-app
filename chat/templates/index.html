{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}
    {{ app_name }} | Home
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4" id="rooms-list">
        {% for room in object_list %}
            <div id="room-{{ room.id }}" class="card bg-base-100 shadow-md border border-base-200">
                <div class="card-body">
                    <h2 class="card-title text-primary">{{ room.room_name }}</h2>
                    <p class="description text-sm text-base-content/80 truncate">{{ room.room_description|truncatewords:20 }}</p>
                    <div class="mt-2 flex flex-col gap-1">
                        <span class="text-sm text-base-content/60">
                            <span class="font-semibold">Author:</span> {{ room.room_author.username }}
                        </span>
                        <span class="text-sm text-base-content/60">
                            <span class="font-semibold">Created:</span> {{ room.created_at|date:"Y-m-d H:i" }}
                        </span>
                    </div>
                    <div class="card-actions justify-end mt-4">
                        {% if request.user.is_authenticated and room.room_author == request.user %}
                            <a href="{% url 'remove_room' room.id %}" class="btn btn-sm btn-soft btn-error">Remove</a>
                            <a href="{% url 'edit_room' room.id %}" class="btn btn-sm btn-soft btn-accent">Edit</a>
                        {% endif %}

                        {% if request.user.is_authenticated %}
                        <a href="{% url 'room-detail' room.id %}" class="btn btn-sm btn-primary btn-soft">Show More</a>
                        <a href="{% url 'chat_room' room.id %}" class="btn btn-sm btn-secondary btn-soft">Join</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-span-full text-center text-gray-500 text-lg">
                No rooms available.
            </div>
        {% endfor %}
    </div>

    <script>
        const roomsList = document.getElementById("rooms-list");

        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/rooms/");

        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
        const currentUserId = {{ request.user.id|default:"null" }};

        console.log(isAuthenticated , currentUserId)


        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);



            if (data.type === "room.created") {
                const room = data.room;

                console.log(room.room_author_id)
                console.log(room)

                if (!document.getElementById(`room-${room.id}`)) {
                    const div = document.createElement("div");
                    div.id = `room-${room.id}`;
                    div.className = "card bg-base-100 shadow-md border border-base-200";
            
                    const cardBody = document.createElement("div");
                    cardBody.className = "card-body";
            
                    const title = document.createElement("h2");
                    title.className = "card-title text-primary";
                    title.textContent = room.room_name;
            
                    const description = document.createElement("p");
                    description.className = "description text-sm text-base-content/80 truncate";
                    description.textContent = room.room_description;
            
                    const infoContainer = document.createElement("div");
                    infoContainer.className = "mt-2 flex flex-col gap-1";
            
                    const authorSpan = document.createElement("span");
                    authorSpan.className = "text-sm text-base-content/60";
                    authorSpan.innerHTML = `<span class="font-semibold">Author:</span> `;
                    authorSpan.appendChild(document.createTextNode(room.room_author));
            
                    const createdSpan = document.createElement("span");
                    createdSpan.className = "text-sm text-base-content/60";
                    createdSpan.innerHTML = `<span class="font-semibold">Created:</span> `;
                    createdSpan.appendChild(document.createTextNode(room.created_at));
            
                    infoContainer.appendChild(authorSpan);
                    infoContainer.appendChild(createdSpan);
            
                    const actionsDiv = document.createElement("div");
                    actionsDiv.className = "card-actions justify-end mt-4";
            
                    if (isAuthenticated && room.room_author_id === currentUserId) {
                        const removeLink = document.createElement("a");
                        removeLink.className = "btn btn-sm btn-soft btn-error";
                        removeLink.href = `/remove-room/${room.id}`;
                        removeLink.textContent = "Remove";
                        actionsDiv.appendChild(removeLink);
                
                        const editLink = document.createElement("a");
                        editLink.className = "btn btn-sm btn-soft btn-accent";
                        editLink.href = `/edit-room/${room.id}`;
                        editLink.textContent = "Edit";
                        actionsDiv.appendChild(editLink);
                    }
            
                    if (isAuthenticated) {
                        const showMoreLink = document.createElement("a");
                        showMoreLink.className = "btn btn-sm btn-primary btn-soft";
                        showMoreLink.href = `/rooms/${room.id}/`;
                        showMoreLink.textContent = "Show More";
                        actionsDiv.appendChild(showMoreLink);
                
                        const joinLink = document.createElement("a");
                        joinLink.className = "btn btn-sm btn-secondary btn-soft";
                        joinLink.href = `/chat-room/${room.id}`;
                        joinLink.textContent = "Join";
                        actionsDiv.appendChild(joinLink);
                    }
            
                    cardBody.appendChild(title);
                    cardBody.appendChild(description);
                    cardBody.appendChild(infoContainer);
                    cardBody.appendChild(actionsDiv);
            
                    div.appendChild(cardBody);
            
                    roomsList.prepend(div);
                }
            }
            else if (data.type === "room.updated"){

                const room = data.room;
                const room_name_div = document.querySelector(`#room-${room.id} .card-body .card-title`)
                const room_description_div = document.querySelector(`#room-${room.id} .card-body .description`)


                room_name_div.textContent = room.room_name
                room_description_div.textContent = room.room_description
            }
            else if (data.type == "room.deleted"){
                const room = data.room 


                const existing = document.getElementById(`room-${room.id}`);

                if (existing) {
                    existing.remove();
                }
            }
        };

        socket.onopen = function () {
            console.log("WebSocket connected.");
        };

        socket.onclose = function () {
            console.log("WebSocket disconnected.");
        };
    </script>
{% endblock %}
