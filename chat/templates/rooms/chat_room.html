{% extends 'base.html' %}

{% block title %}{{ room.room_name }} | ChatApp{% endblock %}

{% block content %}
<div class="flex flex-col h-screen" data-theme="halloween">
  <!-- Header with Halloween accent -->
  <div class="p-4 border-b border-primary bg-neutral sticky top-0 z-10">
    <div class="flex items-center justify-between">
      <div class="flex-1 min-w-0">
        <h2 class="text-xl font-bold truncate text-primary">{{ room.room_name }}</h2>
        <p class="text-sm truncate text-primary">{{ room.room_description }}</p>
      </div>
    </div>
  </div>

  <!-- Chat Messages with Halloween colors -->
  <div id="chat-log" class="flex-1 overflow-y-auto p-4 space-y-4 bg-base-100">
    {% with previous_user=None %}
      {% for msg in chat_msgs %}
        <div id="msg-{{ msg.id }}" class="flex items-start gap-3 group">
          <div class="avatar">
            <div class="w-10 rounded-full border-2 border-primary">
              <img src="{{ msg.message_author.profile.url }}" alt="{{ msg.message_author.username }}" />
            </div>
          </div>
          
          <div class="flex-1 max-w-[80%] relative">
            <div class="flex items-center mb-1">
              <span class="font-bold {% if msg.message_author == current_user %}text-primary{% else %}text-white{% endif %}">
                {{ msg.message_author.username }}
              </span>
              <time class="text-xs opacity-70 ml-2">{{ msg.created_at|date:"H:i" }}</time>
            </div>
            
            {% if msg.reply_to %}
              <a href="#msg-{{ msg.reply_to.id }}" onclick="highlightMessage('msg-{{ msg.reply_to.id }}')" 
                 class="text-xs border-l-4 border-accent pl-2 mb-1 bg-neutral text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M3 6h7m1 12l4-4-4-4" />
                </svg>
                <strong>{{ msg.reply_to.message_author.username }}:</strong>
                <span class="truncate ml-1">{{ msg.reply_to.message_content|truncatechars:40 }}</span>
              </a>
            {% endif %}
            
            <div class="relative">
              <div class="chat-bubble {% if msg.message_author == current_user %}chat-bubble-primary{% else %}chat-bubble-natural{% endif %}">
                {{ msg.message_content }}
              </div>
              
              <div class="absolute -top-4 right-0 flex gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200">
                <button onclick="setReply({{ msg.id }}, '{{ msg.message_author.username }}', `{{ msg.message_content|escapejs }}`)" 
                        class="btn btn-xs btn-circle btn-ghost hover:bg-primary hover:text-primary-content">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M3 6h7m1 12l4-4-4-4" />
                  </svg>
                </button>
                {% if msg.message_author == current_user %}
                  <button onclick="deleteMessage({{ msg.id }})" 
                          class="btn btn-xs btn-circle btn-ghost hover:bg-error hover:text-error-content">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endwith %}
    
    <div id="scroll-anchor"></div>
  </div>

  <!-- Reply Preview with Halloween style -->
  <div id="reply-box" class="hidden mx-4 mt-2 mb-1">
    <div class="flex items-center bg-neutral text-neutral-content rounded-lg p-2 border border-primary shadow-lg">
      <div class="flex-1 min-w-0">
        <p class="text-xs font-bold truncate">
          Replying to <span class="text-accent" id="reply-user"></span>
        </p>
        <p class="text-xs truncate text-secondary" id="reply-content"></p>
      </div>
      <button onclick="clearReply()" class="btn btn-xs btn-circle btn-ghost hover:bg-error hover:text-error-content">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Message Input with Halloween theme -->
  <div class="p-4 border-t border-primary bg-neutral sticky bottom-0">
    <form method="post" class="flex gap-2">
      {% csrf_token %}
      <input type="hidden" name="reply_id" id="reply-id" value="">
      <input name="chat_message" type="text" placeholder="Type your message..." 
             class="input input-bordered flex-1 bg-base-100 focus:border-primary focus:ring-2 focus:ring-primary" 
             autocomplete="off" autofocus>
      <button type="submit" class="btn btn-primary gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
        </svg>
        Send
      </button>
    </form>
  </div>

  <script>
    // Auto scroll to bottom when page loads
    function scrollToBottom() {
      const anchor = document.getElementById('scroll-anchor');
      anchor.scrollIntoView({ behavior: 'instant' });
    }

    window.addEventListener('load', () => {
      scrollToBottom();
      
      if (location.hash.startsWith('#msg-')) {
        highlightMessage(location.hash.substring(1));
      }
    });

    function highlightMessage(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('animate-pulse', 'bg-primary', 'bg-opacity-10');
      setTimeout(() => {
        el.classList.remove('animate-pulse', 'bg-primary', 'bg-opacity-10');
      }, 2000);
    }

    let replyId = null;

    function setReply(id, username, message) {
      replyId = id;
      const maxLength = 50;
      let displayMsg = message.length > maxLength ? message.substring(0, maxLength) + "..." : message;
      document.getElementById('reply-id').value = id;
      document.getElementById('reply-user').textContent = username;
      document.getElementById('reply-content').textContent = displayMsg;
      document.getElementById('reply-box').classList.remove('hidden');
      document.querySelector('input[name="chat_message"]').focus();
    }

    function clearReply() {
      replyId = null;
      document.getElementById('reply-id').value = '';
      document.getElementById('reply-user').textContent = '';
      document.getElementById('reply-content').textContent = '';
      document.getElementById('reply-box').classList.add('hidden');
    }

    window.addEventListener('hashchange', () => {
      if (location.hash.startsWith('#msg-')) {
        highlightMessage(location.hash.substring(1));
      }
    });

    function deleteMessage(id) {
      if (confirm('Are you sure you want to delete this message?')) {
        // Implement actual delete functionality here
        console.log('Delete message id:', id);
      }
    }

    // For real-time updates
    function addNewMessage() {
      // ... add new message logic ...
      scrollToBottom();
    }
  </script>
</div>
{% endblock %}